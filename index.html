<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Surf Forecast</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; background: #eef2f5; color: #333; }
    header { background: #1e3a8a; color: #fff; padding: 1rem; text-align: center; }
    .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
    .search { margin-bottom: 1.5rem; display: flex; justify-content: center; }
    .search input { width: 300px; padding: 0.5rem 1rem; border: 1px solid #ccc; border-radius: 4px 0 0 4px; }
    .search button { padding: 0.5rem 1rem; border: none; background: #2563eb; color: white; border-radius: 0 4px 4px 0; cursor: pointer; }
    .day-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; }
    .day-card { background: #fff; border-radius: 8px; padding: 1rem; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; }
    .rating { font-size: 1.2rem; font-weight: 500; }
    .rating.gray { color: #6b7280; }
    .rating.yellow { color: #facc15; }
    .rating.green { color: #22c55e; }
    .rating.blue { color: #60a5fa; }
    .rating.purple { color: #a78bfa; }
    .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; }
    .modal-content { background: #fff; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; padding: 1.5rem; position: relative; }
    .close { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; }
    .compass-container { position: relative; width: 100%; height: 300px; }
    #compass { width: 100%; height: 100%; }
    .slider { width: 100%; margin-top: 1rem; }
    .key { display: flex; gap: 1rem; margin-top: 1rem; }
    .key-item { display: flex; align-items: center; gap: 0.5rem; }
    .arrow-sample { width: 20px; height: 20px; }
    footer { text-align: center; margin: 2rem 0; font-size: 0.9rem; color: #555; }
  </style>
</head>
<body>
  <header><h1>Surf Forecast</h1></header>
  <div class="container">
    <div class="search">
      <input id="locationInput" placeholder="City or ZIP (e.g. Ocean City, NJ)" />
      <button id="searchBtn">Get Forecast</button>
    </div>
    <div id="dayList" class="day-list"></div>
    <footer id="lastUpdated">Last updated: --</footer>
  </div>

  <div id="detailModal" class="modal" role="dialog" aria-labelledby="detailDate">
    <div class="modal-content">
      <button class="close" aria-label="Close modal">&times;</button>
      <h2 id="detailDate"></h2>
      <div id="detailStats"></div>
      <div class="compass-container"><canvas id="compass"></canvas></div>
      <input type="range" id="hourSlider" class="slider" min="0" max="23" value="0" aria-label="Select hour" />
      <div class="key">
        <div class="key-item"><canvas class="arrow-sample" id="swellKey"></canvas><span>Swell</span></div>
        <div class="key-item"><canvas class="arrow-sample" id="windKey"></canvas><span>Wind</span></div>
      </div>
    </div>
  </div>

  <script>
    // Simple geocode with Nominatim
    async function geocode(place) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`);
      const data = await res.json();
      if (!data || !data.length) throw new Error('Location not found');
      return data[0]; // { lat, lon }
    }

    // Fetch NWS daily + hourly
    async function fetchNWS(lat, lon) {
      const pts = await fetch(`https://api.weather.gov/points/${lat},${lon}`).then(r => r.json());
      const daily = await fetch(pts.properties.forecast).then(r => r.json()).then(j => j.properties.periods);
      const hourly = await fetch(pts.properties.forecastHourly).then(r => r.json()).then(j => j.properties.periods);
      return { daily, hourly };
    }

    // Rating based on swell ft and wind kt
    function getRating({ swell, wind }) {
      const score = swell * 1 - wind / 10;
      if (score < 3) return { label:'Flat', color:'gray' };
      if (score < 6) return { label:'Okay', color:'yellow' };
      if (score < 9) return { label:'Good', color:'green' };
      if (score <12) return { label:'Great', color:'blue' };
      return { label:'Epic', color:'purple' };
    }

    // Helper to parse date part
    const datePart = dt => dt.split('T')[0];

    document.getElementById('searchBtn').addEventListener('click', async () => {
      const place = document.getElementById('locationInput').value;
      try {
        const loc = await geocode(place);
        const nws = await fetchNWS(loc.lat, loc.lon);
        renderDays(nws.daily, nws.hourly);
        document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleString();
      } catch (e) {
        alert('Error: '+e.message);
      }
    });

    function renderDays(daily, hourly) {
      const list = document.getElementById('dayList'); list.innerHTML = '';
      const hoursByDate = {};
      hourly.forEach(h => {
        const d = datePart(h.startTime);
        if (!hoursByDate[d]) hoursByDate[d] = [];
        hoursByDate[d].push(h);
      });

      daily.slice(0,10).forEach(day => {
        const d = datePart(day.startTime);
        const hrs = hoursByDate[d]||[];
        if (!hrs.length) return;
        // find best hour
        let best = hrs[0]; let bestR = getRating({ swell:0, wind:100 });
        hrs.forEach(h => {
          const swell = parseFloat((h.shortForecast.match(/(\d+)-?(\d*) ft/)||[])[1]||0);
          const wind  = h.windSpeed.value||0;
          const r = getRating({ swell, wind });
          if (r.label==='Epic' || (r.label==='Great'&&bestR.label!=='Epic') ) { best=h; bestR=r; }
        });
        const card = document.createElement('div'); card.className='day-card';
        card.innerHTML = `<div><strong>${day.name}</strong></div>
                          <div class="rating ${bestR.color}">${bestR.label} @ ${new Date(best.startTime).getHours()}:00</div>`;
        card.onclick = ()=>showDetail(day, hrs);
        list.appendChild(card);
      });
    }

    // Compass drawing
    const compass = document.getElementById('compass');
    const ctx = compass.getContext('2d');
    function drawArrow(dir, length, color) {
      const centerX = compass.width/2, centerY = compass.height/2;
      const rad = (dir-90)*Math.PI/180;
      const x2 = centerX + Math.cos(rad)*length;
      const y2 = centerY + Math.sin(rad)*length;
      ctx.strokeStyle = color; ctx.fillStyle=color; ctx.lineWidth=4;
      ctx.beginPath(); ctx.moveTo(centerX,centerY); ctx.lineTo(x2,y2); ctx.stroke();
      // arrow head
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(x2 - Math.cos(rad+0.3)*10, y2 - Math.sin(rad+0.3)*10);
      ctx.lineTo(x2 - Math.cos(rad-0.3)*10, y2 - Math.sin(rad-0.3)*10);
      ctx.closePath(); ctx.fill();
    }

    function showDetail(day, hours) {
      document.getElementById('detailModal').style.display='flex';
      document.getElementById('detailDate').textContent = day.name;
      document.getElementById('detailStats').innerHTML = `<p>${day.shortForecast}</p>`;
      const slider = document.getElementById('hourSlider');
      slider.max = hours.length-1; slider.value=0;
      slider.oninput = ()=>updateCompass(hours[slider.value]);
      updateCompass(hours[0]);
      // legend arrows
      ['swellKey','windKey'].forEach(id=>{
        const c = document.getElementById(id).getContext('2d'); c.clearRect(0,0,20,20);
      });
      drawKey();
    }

    function updateCompass(hour) {
      ctx.clearRect(0,0,compass.width,compass.height);
      const swell = parseFloat((hour.shortForecast.match(/(\d+)-?(\d*) ft/)||[])[1]||0);
      const wind  = hour.windSpeed.value||0;
      const swellDir = hour.windDirection.value; // approximate
      const windDir  = hour.windDirection.value;
      drawArrow(swellDir, 100, '#333');
      drawArrow(windDir, 70, '#aaa');
    }

    function drawKey() {
      const sk = document.getElementById('swellKey').getContext('2d');
      sk.strokeStyle='#333'; sk.lineWidth=3;
      sk.beginPath(); sk.moveTo(10,18); sk.lineTo(10,5); sk.stroke();
      sk.beginPath(); sk.moveTo(10,5); sk.lineTo(5,12); sk.lineTo(15,12); sk.closePath(); sk.fillStyle='#333'; sk.fill();
      const wk = document.getElementById('windKey').getContext('2d');
      wk.strokeStyle='#aaa'; wk.lineWidth=3;
      wk.beginPath(); wk.moveTo(10,18); wk.lineTo(10,5); wk.stroke();
      wk.beginPath(); wk.moveTo(10,5); wk.lineTo(5,12); wk.lineTo(15,12); wk.closePath(); wk.fillStyle='#aaa'; wk.fill();
    }

    document.querySelector('.close').onclick = ()=>{ document.getElementById('detailModal').style.display='none'; };
    window.addEventListener('load', ()=>{
      document.getElementById('locationInput').value='Ocean City, NJ';
      document.getElementById('searchBtn').click();
    });
  </script>
</body>
</html>
